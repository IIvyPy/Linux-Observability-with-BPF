在软件工程中，跟踪是一种收集数据以进行概要分析和调试的方法。目的是在运行时提供有用的信息以供将来分析。使用BPF进行跟踪的主要优点是，您可以从Linux内核和应用程序访问几乎任何信息。与其他跟踪技术相比，BPF在系统性能和延迟方面增加了最少的开销，并且不需要开发人员修改应用程序只是为了从中收集数据。

Linux内核提供了一些可与BPF结合使用的检测功能。在本章中，我们将讨论这些不同的功能。我们向您展示了内核如何在操作系统中公开这些功能，从而使您知道如何找到BPF程序可用的信息。

跟踪的最终目标是通过收集所有可用数据并以有用的方式将其呈现给您，从而使您对任何系统都有深刻的了解。我们将讨论几种不同的数据表示形式，以及如何在不同的情况下使用它们。

从本章开始，我们将使用功能强大的工具包来编写BPF程序BPF编译器集合（BCC）。 BCC是使构建BPF程序更可预测的一组组件。即使您掌握了Clang和LLVM，您可能也不想花更多的时间来构建相同的实用程序，并确保BPF验证程序不会拒绝您的程序。 BCC为常见结构（如Perf事件映射）提供了可重用的组件，并与LLVM后端集成以提供更好的调试选项。最重要的是，BCC包含了几种编程语言的绑定。我们将在示例中使用Python。这些绑定使您可以用高级语言编写BPF程序的用户态部分，这将导致程序更有用。在以下各章中，我们还将使用BCC，以使示例更简洁。

能够跟踪Linux内核中的程序的第一步是确定它为您提供的附加BPF程序的扩展点。这些扩展点通常称为探针。

### 探针

英语词典中单词probe的定义之一如下：

```sh
    An unmanned exploratory spacecraft designed to transmit information about its
environment.
```

这个定义让人想起科幻电影和史诗般的NASA任务的记忆，也可能在您的脑海中。当我们谈论跟踪探针时，我们可以使用非常相似的定义。

```sh
    跟踪探针是探索性程序，旨在传输有关其执行环境的信息。
```

他们收集您系统中的数据，并提供给您进行探索和分析。传统上，在Linux中使用探针需要编写被编译为内核模块的程序，这可能会在生产系统中引起灾难性问题。多年来，它们进化为执行起来更安全，但编写和测试仍然很麻烦。诸如SystemTap之类的工具建立了新的协议来编写探针，并为从Linux内核和在用户态上运行的所有程序获取更丰富的信息铺平了道路。

BPF搭载在跟踪探针上以收集信息以进行调试和分析。 BPF程序的安全性使其比仍依赖于重新编译内核的工具更具吸引力。重新编译内核以包括外部模块可能会导致由于行为不当而导致崩溃的风险。 BPF验证程序通过在装入内核之前分析程序来消除此风险。 BPF开发人员利用了探针定义，并在代码执行找到这些定义之一时修改了内核以执行BPF程序，而不是内核模块。

了解您可以定义的不同探针类型是探索系统中正在发生的事情的基础。在本节中，我们对不同的探针定义，如何在系统中发现它们以及如何将BPF程序附加到它们进行分类。

在本章中，我们涵盖四种不同类型的探针：

*内核探针*

```sh
    这些使您可以动态访问内核中的内部组件。
```

*追踪点*

```sh
    这些提供对内核中内部组件的静态访问。
```

*用户态探针*

```sh
    这些使您可以动态访问在用户态中运行的程序。
```

*用户静态定义的跟踪点*

```sh
    这些允许静态访问在用户态中运行的程序。
```

### 内核探针



### Perf 事件

我们认为，Perf事件可能是您成功掌握BPF跟踪所需要掌握的最重要的通信方法。在上一章中，我们讨论了BPF Perf事件数组映射。它们使您可以将数据放入与用户态程序实时同步的缓冲环中。当您在BPF程序中收集大量数据并希望将处理和可视化工作分流到用户态程序时，这是理想的选择。这将使您可以在表示层上进行更多控制，因为BPF VM在编程功能方面不受限制。您可以找到的大多数BPF跟踪程序仅将Perf事件用于此目的。




### 结论

在本章中，我们仅介绍了使用BPF进行跟踪的内容。 Linux内核使您可以访问使用其他工具更难获得的信息。 BPF使此过程更具可预测性，因为它提供了访问此数据的通用接口。在后面的章节中，您将看到更多使用此处介绍的某些技术的示例，例如将函数附加到跟踪点。他们将帮助您巩固您在这里学到的知识。

我们在本章中使用BCC框架来编写大多数示例。您可以像在前几章中一样在C中实现相同的示例，但是BCC提供了一些内置功能，这些功能使编写跟踪程序比C更加容易。如果您遇到有趣的挑战，请尝试用C重写这些示例。

在下一章中，我们将向您展示系统社区基于BPF构建的一些工具，用于进行性能分析和跟踪。编写自己的程序功能强大，但是这些专用工具可让您访问打包格式的许多信息。这样，您无需重写已经存在的工具。